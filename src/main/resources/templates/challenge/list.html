<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
	
<!-- include CSS File -->
<th:block layout:fragment="css">
	<!-- Handa Challenge CSS File -->
	<link th:href="@{/assets/css/challenge.css}" rel="stylesheet">
</th:block>

<div layout:fragment="content">
	<main id="main">

		<!-- ======= Breadcrumbs ======= -->
		<div class="breadcrumbs">
			<div class="page-header d-flex align-items-center"
				style="background-image: url('assets/img/page-header.jpg');">
				<div class="container position-relative">
					<div class="row d-flex justify-content-center">
						<div class="col-lg-6 text-center">
							<h2>Challenge List</h2>
							<p>원하는 챌린지에 참여해보세요.</p>
						</div>
					</div>
				</div>
			</div>
			<nav>
				<div class="container">
					<ol>
						<li><a th:href="@{/list}">홈</a></li>
						<li>챌린지 리스트</li>
						<!-- 카테고리 조회일 경우에만 표시 -->
						<li th:if="${not #strings.isEmpty(mainCategoryName)}" th:text=${mainCategoryName}></li>
						<li th:if="${not #strings.isEmpty(subCategoryName)}"th:text=${subCategoryName}></li>
					</ol>
				</div>
			</nav>
		</div>
		<!-- End Breadcrumbs -->

		<!-- ======= Services Section ======= -->
		<section id="service" class="services pt-0">
			<div class="container" data-aos="fade-up">

				<div class="section-header">
					 <span>챌린지 리스트</span>
          			 <h2>챌린지 리스트</h2>
				</div>

				<div class="row gy-4">
					<div class="create-challenge-div">
						<a href="/create" class="create-challenge-btn">챌린지 생성</a>
					</div>
					<div class="row gy-4">
						<div class="btn-group order-div col-2">
							<select class="form-control handa-list-select" onchange="if(this.value) location.href=(this.value);">
								<th:block th:if="${#strings.isEmpty(isCategory)} or ${!isCategory}">
									<option th:value="@{/list?sortType=0}" th:text="최신순" th:selected="${sortType} == '0'"></option>
									<option th:value="@{/list?sortType=1}" th:text="오래된순" th:selected="${sortType} == '1'"></option>
									<option th:value="@{/list?sortType=2}" th:text="참여인원순" th:selected="${sortType} == '2'"></option>
								</th:block>
								
								<th:block th:if="${isCategory}">
									<option th:value="@{${'/list?category=' + {categoryID} + '&sortType=0'}}" th:text="최신순" th:selected="${sortType} == '0'"></option>
									<option th:value="@{${'/list?category=' + {categoryID} + '&sortType=1'}}" th:text="오래된순" th:selected="${sortType} == '1'"></option>
									<option th:value="@{${'/list?category=' + {categoryID} + '&sortType=2'}}" th:text="참여인원순" th:selected="${sortType} == '2'"></option>
								</th:block>
							</select>
						</div>
						<div class="col-6"></div>
						<div class="search-div col-4">
							<form action="#" class="form-search handa-search-form">
								<input type="text" class="form-control"
									placeholder="검색어를 입력하세요.">
								<button type="submit"
									class="btn btn-primary handa-outline-btn list-search-btn">검색</button>
							</form>
						</div>
						<div class="col-md-12"></div>
						
							<!-- 챌린지 리스트 -->
							<div id="list-container" class="row gy-4">
							</div> 

						</div>
					</div>
				</div>
		</section>
		<!-- End Services Section -->
	</main>
	<!-- End #main -->
</div>
	<!-- include JS Script -->
	<th:block layout:fragment="javascript">   
		<script src='../assets/js/infiniteScroll.js'></script>
		<script th:inline='javascript'>
			//$(function(){
			$(document).ready(function(){
				console.log("asdasd");
				var category = "[[${categoryID}]]";		// 카테고리 ID
				var sortType = "[[${sortType}]]";		// 정렬 타입
				
				if(category == "null") category = "0"; 	// 전체 조회의 경우
				if(sortType == "null") sortType = "0"; 	// 정렬 타입 주어지지 않은 경우
				
				//alert(category + sortType);
				
				$.ajax({
					type : 'GET',
					url : '/challenge-list',
					dataType : 'json',
 					data:{
						category: category, 
						sortType: sortType
					},  
					contentType : 'application/json',
					success: function(res){
						const challengeList = res['challengeList'];
						const subCategoryName = res['subCategoryName'];

						var data = "";
						
						for(var i = 0; i < challengeList.length; i++){
								data += "<div class='card-container col-lg-4 col-md-6' data-aos='fade-up' data-aos-delay='100'>";
								data += "<div class='card challenge-item'>";
								data += "<div class='card-img'>";
								data +=	"<img src='" + challengeList[i]['thumbnail'] + "' alt='' class='img-fluid challenge-thumbnail'>";
								data += "</div>";

								
								data += "<h3>";
								
								if(subCategoryName != null){
									data += "<a href='/detail' class='stretched-link'>[" + subCategoryName + "] " + challengeList[i]['challenge_name'] + "</a>";
								}else {
									data += "<a href='/detail' class='stretched-link'>[" + challengeList[i]['subcategory_name'] + "] " + challengeList[i]['challenge_name'] + "</a>";
								}
								
								data += "</h3>";
		
								data += "<p id='card-p'>" + challengeList[i]['startdate'] + " ~ " + challengeList[i]['enddate'] + "</p>";
								data += "<p id='card-p'> 참여인원 " + challengeList[0]['joinVO']['count'] + "명 </p>";
								
								data += "<div class='state'>";
								data += "<div class='open-dt'>" + challengeList[i]['createdate'] + " 생성 </div>"; 
								data +=	"<div class='state-label'>" + challengeList[i]['challenge_state'] + "</div>";
								data += "</div>";
								
								data += "<div id ='endList'></div>";
								data += "</div>";
								
								data += "</div>";
								data += "</div>"; 

						}
						$("#list-container").html(data);
						
					},
					error: function(){
						alert('실패!');
					}
				});
			}); 
		</script>
	</th:block>
</html>